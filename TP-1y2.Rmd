---
title: "TP 1y2"
author: "Cande y agus"
date: "2025-08-12"
output: html_document
---

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
setwd("C:/Users/agusr/Desktop/Diplo CSCyHD")
getwd()
```

Cargamos librerías

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Paquetes
library(data.table)
library(dplyr)
library(lubridate)
library(readxl)
library(ggplot2)
library(plotly)
library(sf)
library(tmap)
library(scales)
# Performance: permitir usar todos los cores
data.table::setDTthreads(0)
norm_dep <- function(x) sprintf("%05d", as.integer(x))
```

Carga todos los paquetes necesarios para manejo de datos, fechas, gráficos y mapas. Además, activa todos los núcleos para data.table y define funciones auxiliares (como norm_dep)

# ============================

# 1) FUNCION FECHAS

# ============================

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

parse_ym <- function(x){
  x <- as.character(x)
  out <- rep(NA_character_, length(x))
  sel_date <- grepl("^\\d{4}-\\d{2}-\\d{2}$", x)
  out[sel_date] <- x[sel_date]
  sel_ym <- grepl("^\\d{4}[-/]?\\d{2}$", x) & !grepl("^\\d{4}$", x)
  out[sel_ym] <- paste0(sub("[-/]", "-", x[sel_ym]), "-01")
  sel_yymm <- grepl("^\\d{6}$", x)
  out[sel_yymm] <- paste0(substr(x[sel_yymm],1,4), "-", substr(x[sel_yymm],5,6), "-01")
  sel_yyyy <- grepl("^\\d{4}$", x)
  out[sel_yyyy] <- paste0(x[sel_yyyy], "-01-01")
  as.Date(out)
}
```

Convierte fechas en distintos formatos (YYYYMM, YYYY-MM, YYYY) a un objeto Date estándar, asegurando consistencia temporal en los análisis.

# ============================

# 2) LEER SALARIOS (w_dt)

# ============================

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
cols_needed <- c("fecha", "codigo_departamento_indec", "id_provincia_indec", "letra", "w_mean")
w_dt <- fread("w_mean_depto_tot_emp_letra.csv", select = cols_needed, na.strings = c("","NA","NaN"))
w_dt[, fecha := parse_ym(fecha)]
# Convertir códigos de error a NA
w_dt[w_mean <=0, w_mean := NA_real_]

```

Carga datos de salarios por departamento y sector. Convierte valores inválidos o negativos en NA y aplica la función parse_ym para estandarizar fechas.

# ============================

# 3) Merge IPC ya indexado y deflactar salarios

# ============================

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# 1) Leer IPC
ipc <- read_excel("ipc.xlsx") %>% 
  rename(ipc_varm = 2) %>%
  mutate(fecha = as.Date(fecha)) %>%
  arrange(fecha)  # de más antiguo a más reciente


# Asegurar data.tables
setDT(w_dt)
setDT(ipc)

# Eliminar columna por si existe de corridas previas
w_dt[, idx_jun2025 := NULL]

# Merge por fecha, usando el índice ya calculado en Excel
setkey(w_dt, fecha)
setkey(ipc, fecha)
w_dt <- merge(w_dt, ipc[, .(fecha, idxjun25)], by = "fecha", all.x = TRUE)

# Deflactar salarios a precios de junio 2025
w_dt[, w_mean_const := w_mean / (idxjun25 / 100)]

```

Importa el índice de precios (IPC), lo combina con los salarios y calcula los salarios constantes (precios de junio 2025), para poder comparar valores a lo largo del tiempo.

# ============================

# 4) Diccionario de letras

# ============================

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
dicc_clae <- fread("diccionario_clae2.csv") %>%
  select(letra, letra_desc) %>% distinct()
w_dt <- left_join(w_dt, dicc_clae, by = "letra")
```

Se agregan descripciones de los sectores económicos a partir del código de letra (letra) para facilitar la interpretación de los gráficos.

# ============================

# 5) Promedios por depto y país

# ============================

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}

# Salario mensual por departamento
w_depto_mensual <- w_dt[, .(
  salario_depto = mean(w_mean_const, na.rm = TRUE)
), by = .(fecha, codigo_departamento_indec, id_provincia_indec)]

# Promedio histórico por departamento
dept_promedio <- w_depto_mensual[, .(
  salario_promedio_depto = mean(salario_depto, na.rm = TRUE)
), by = codigo_departamento_indec] 

# Promedio nacional mensual
salario_pais_mensual <- w_depto_mensual[, .(
  salario_pais = mean(salario_depto, na.rm = TRUE)
), by = fecha]


```

Calcula:

Salario mensual promedio por departamento.

Salario promedio histórico por departamento.

Salario promedio nacional mensual, que sirve como referencia para los ratios de sectores

# ============================

# 6) Mapa coroplético

# ============================

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
shape <- st_read("departamentos_arg2025.geojson", quiet = TRUE) %>% 
  st_make_valid() %>% 
  mutate(codigo_departamento_indec = sprintf("%05d", as.integer(codigo_departamento_indec)))

# Asegurarse de que dept_promedio tenga mismo formato
dept_promedio$codigo_departamento_indec <- sprintf("%05d", as.integer(dept_promedio$codigo_departamento_indec))

shape <- st_simplify(shape, dTolerance = 1000)  # valor en metros, ajustá según escala

# ----------------------------
#$Merge con salario promedio por depto
# ----------------------------
shape_joined <- left_join(shape, dept_promedio, by = "codigo_departamento_indec")

# ----------------------------
# 3) Modo view y mapa interactivo
# ----------------------------
tmap_mode("view")

tm_shape(shape_joined) +
  tm_polygons("salario_promedio_depto",
              palette = "YlOrRd",
              title = "Salario real (Jun 2025)",
              popup.vars = c("codigo_departamento_indec", "salario_promedio_depto")) +
  tm_basemap("OpenStreetMap")

```

Carga y simplifica el shapefile de departamentos.

Une la geometría con los salarios promedio por departamento.

Crea un mapa interactivo (tmap) mostrando el salario real de cada departamento.

# ============================

# 7) 5 sectores con salarios más bajos

# ============================

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
sector_means <- w_dt[, .(
  salario_promedio_letra = mean(w_mean_const, na.rm = TRUE)
), by = .(letra, letra_desc)][order(salario_promedio_letra)]

p_barras <- ggplot(head(sector_means, 5), aes(x = reorder(letra_desc, salario_promedio_letra),
                                              y = salario_promedio_letra,
                                              fill = letra_desc,
                                              text = paste("Sector:", letra_desc,
                                                           "<br>Salario:", round(salario_promedio_letra, 2)))) +
  geom_col() +
  coord_flip() +
  labs(title = "5 sectores con salarios más bajos",
       y = "Salario promedio (Jun 2025)", x = "") +
  theme_minimal() +
  theme(legend.position = "none")

ggplotly(p_barras, tooltip = "text")

```

Calcula el salario promedio por sector.

Genera un gráfico de barras horizontales con los 5 sectores más bajos.

Tooltip interactivo muestra sector y salario.

# ============================

# 8) Evolución 4 sectores seleccionados vs promedio nacional

# ============================

```{r echo=TRUE, message=FALSE, warning=FALSE, paged.print=FALSE}
# Definir sectores de interés
sectores_sel <- c("A","B","C","D")  # reemplazá con las letras de tus sectores

# Calcular promedio mensual por sector
serie_letra_fecha <- w_dt[letra %in% sectores_sel, .(
  salario_letra = mean(w_mean_const, na.rm = TRUE)
), by = .(fecha, letra)] %>%
  left_join(salario_pais_mensual, by = "fecha") %>%
  mutate(ratio = salario_letra / salario_pais) %>%
  left_join(dicc_clae, by = "letra")  # para agregar letra_desc
serie_letra_fecha <- left_join(serie_letra_fecha, dicc_clae, by = "letra")
serie_letra_fecha$letra_desc <- serie_letra_fecha$letra_desc.y
serie_letra_fecha$letra_desc.x <- NULL
serie_letra_fecha$letra_desc.y <- NULL

p_lineas <- ggplot(serie_letra_fecha, 
                   aes(x = fecha, y = ratio, color = letra_desc, group = letra_desc,
                       text = paste("Fecha:", fecha,
                                    "<br>Sector:", letra_desc,
                                    "<br>Ratio:", round(ratio,2)))) +
  geom_line(linewidth = 1.5) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  labs(title = "Evolución salarios / promedio nacional",
       subtitle = "A precios constantes de Junio 2025",
       x = "", y = "Ratio") +
  theme_minimal()+
  theme(
    legend.position = "bottom",          # debajo del gráfico
    legend.direction = "horizontal",     # horizontal
    legend.box = "horizontal",           # caja horizontal
    legend.title = element_text(size = 7, face = "bold"),
    legend.text  = element_text(size = 5)
  )

ggplotly(p_lineas, tooltip = "text")


```

Filtra sectores de interés y calcula el salario promedio mensual por sector.

Calcula el ratio respecto al salario promedio nacional.

Añade descripciones de sectores y genera gráfico interactivo de líneas (ggplotly) mostrando la evolución de cada sector y el promedio nacional.

La línea y=1 representa el promedio nacional y sirve como referencia.

# ============================

# Análisis y conclusión

# ============================

En el mapa coroplético podemos ver el promedio del salario por departamento para la serie que va desde 20144 hasta octubre de 2023, que muestra el salario bruto percibido por todo concepto de los trabajadores privados registrados, todo a precios de junio de 2025 de modo de que no se pondere más a los salarios relativamente mas recientes y con una ponderacion sesgada hacia arriba por el efecto de la nominalidad. Vemos que a precios constantes, en promedio el salario registrado se distribuye de manera heterogénea entre departamentos, oscilando entre los \$500.000 y los \$3.500.000 con mayores salarios en promedio hacia la patagonia. Entre los salarios más altos se encuentra un partido de neuquen, probablemente asociado a la mayor representacion del trabajo de petroleo en el caso de neuquen, mientras que la zona patagonica puede tener salarios promedio más altos que otras zonas por el mayor costo de vida asociado a las zonas frías. Asimismo, capital federal y gran buenos aires gozan de salarios mas altos probablemente por ser ciudad portuaria centro administrativo y financiero nacional. Sin embargo pueden perderse de vista grandes centros urbanos por las subdivisiones de análisis.\
En el caso de los sectores de actividad nomenclados con el CLAE, tomando de referencia todos los departamentos del país, y promediando a precios de junio de 2025 la serie disponible, notamos que el sector de menor salario fue el de servicios de alojamiento y servicios de comida, seguido de enseñanza, actividades administrativas, agricultura ganaderia y salvicultura, y en quinto lugar servicios inmobiliarios oscilando entre 983.000 y 1.238.000 pesos percibidos (bruto).\

Finalmente, al normalizar mes a mes la serie de los sectores elegidos para sectores agricultura suministro de electricidad y gas, explotacion de minas y canteras, e industria, notamos que en linea con las nociones que muestran los primeros datos sobre los salarios relativos, notamos que energia, minas y canteras se encuentra entre 2 y 2,5 veces en promedio por encima del promedio nacional para cada mes. Llamativamente notamos una gran similitud entre el promedio del salario nacional y el salario de la industria manufacturera. Mientras que por su parte el salario del sector agricultura ganaderia pesca y salvicultura se acerca al promedio en los ultimos 6 años, aumentando junto con todas las series la volatilidad.
